#! /usr/bin/env python2
# -*- encoding: utf-8; py-indent-offset: 4 -*-
#
# Author:  Linuxfabrik GmbH, Zurich, Switzerland
# Contact: info (at) linuxfabrik (dot) ch
#          https://www.linuxfabrik.ch/
# License: The Unlicense, see LICENSE file.

# https://git.linuxfabrik.ch/linuxfabrik-icinga-plugins/checks-linux/-/blob/master/CONTRIBUTING.md

__author__  = 'Linuxfabrik GmbH, Zurich/Switzerland'
__version__ = '2020041701'

DESCRIPTION = 'Warns on the newest feed item of an RSS or Atom feed for a given amount of time.'

DEFAULT_FEED_URL = 'https://www.heise.de/security/rss/alert-news-atom.xml'
DEFAULT_NO_SUMMARY = False
DEFAULT_WARN = 120  # minutes


#====================
from lib.globals import *

import lib.base

import argparse
try:
    import feedparser
except ImportError, e:
    print('Python module "feedparser" is not installed.')
    exit(STATE_UNKNOWN)
import time
from traceback import print_exc


def parse_args():
    parser = argparse.ArgumentParser(description=DESCRIPTION)

    parser.add_argument('-V', '--version',
        action = 'version',
        version = '{0}: v{1} by {2}'.format('%(prog)s', __version__, __author__)
        )

    parser.add_argument('--always-ok',
        help = 'Always returns OK.',
        dest = 'ALWAYS_OK',
        action = 'store_true',
        default = False,
        )

    parser.add_argument('--no-summary',
        help = 'Do not show the feed item summary. Default: %(default)s',
        dest = 'NO_SUMMARY',
        action = 'store_true',
        default = DEFAULT_NO_SUMMARY,   # False
        )

    parser.add_argument('-u', '--url',
        help = 'The Feed URL. Default: %(default)s',
        dest = 'FEED_URL',
        default = DEFAULT_FEED_URL,
        )

    parser.add_argument('-w', '--warning',
        help = 'How long should this check return a warning on new entries? Default: %(default)s (minutes)',
        dest = 'WARN',
        type = int,
        default = DEFAULT_WARN,
        )
    
    return parser.parse_args()


def fetch_feed_last_entry(feed_url):
    # got this function from https://github.com/jrottenberg/check_rss/blob/master/check_rss.py
    try:
        myfeed = feedparser.parse(feed_url)
    except:
        lib.base.oao('Could not parse URL (%s)' % feed_url, STATE_UNKNOWN)

    # slightly enhanced
    if ('status' not in myfeed):
        lib.base.oao('HTTP Error, maybe wrong URL', STATE_UNKNOWN)

    if (myfeed.status != 200):
        lib.base.oao('Status %s - %s' % (myfeed.status, myfeed.feed.summary), STATE_UNKNOWN)

    # feed with 0 entries are good too
    if (len(myfeed.entries) == 0): 
        lib.base.oao('No news are good news.', STATE_OK)
    
    return myfeed.entries[0]


def main():
    # parse the command line, exit with UNKNOWN if it fails
    try:
        args = parse_args()
    except SystemExit as e:
        exit(STATE_UNKNOWN)

    feed_item = fetch_feed_last_entry(args.FEED_URL)
    delta = lib.base.now() - time.mktime(feed_item['updated_parsed'])     # in seconds, float

    if args.NO_SUMMARY:
        msg = '{} ({} ago)'.format(feed_item['title'].encode('utf-8').strip(), lib.base.seconds2human(delta))
    else:
        msg = '{}: {} ({} ago)'.format(feed_item['title'].encode('utf-8').strip(), feed_item['summary'].encode('utf-8').strip(), lib.base.seconds2human(delta))

    state = STATE_OK
    if delta/60 < args.WARN:
        state = STATE_WARN

    lib.base.oao(msg, state, always_ok=args.ALWAYS_OK)


if __name__ == '__main__':
    try:
        main()
    except Exception as e:
        print_exc()
        exit(STATE_UNKNOWN)
