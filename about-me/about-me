#! /usr/bin/env python2
# -*- encoding: utf-8; py-indent-offset: 4 -*-
#
# Author:  Linuxfabrik GmbH, Zurich, Switzerland
# Contact: info (at) linuxfabrik (dot) ch
#          https://www.linuxfabrik.ch/
# License: The Unlicense, see LICENSE file.

# https://nagios-plugins.org/doc/guidelines.html

__author__  = 'Linuxfabrik GmbH, Zurich/Switzerland'
__version__ = '2020010801'

DESCRIPTION = 'Reports a quick overview about the host dimensions and installed software. Always returns OK.'


#====================
import argparse
import os
import psutil       # https://pypi.org/project/psutil/
import re

from lib.utils import execute_command
from lib.globals import *
from lib.output import bytes2human, unpack_perfdata


def define_args():
    parser = argparse.ArgumentParser(description=DESCRIPTION)

    parser.add_argument('-V', '--version',
        action = 'version',
        version = '{0}: v{1} by {2}'.format('%(prog)s', __version__, __author__)
        )

    return parser.parse_args()


def execute_command_or_unknown(command):
    stdout, stderr, retc = execute_command(command)
    if (stderr or retc != 0):
        print('Bash command `{}` failed.'.format(command))
        print('Stdout: {}\nStderr: {}'.format(stdout, stderr))
        exit(STATE_UNKNOWN)
    return stdout.strip(), stderr, retc


def find_command(return_text, command, version_cmd=None, version_regex=None):
    stdout, stderr, retc = execute_command(command)
    if retc == 0:
        if version_cmd:
            ver, stderr, retc = execute_command(version_cmd)
            ver = ver.strip()
            # where to find the version number in output?
            if version_regex:
                try:
                    ver = re.search(version_regex, ver)
                    return return_text + ' {}, '.format(ver.group(1).strip())
                except:
                    return ''
            else:
                return return_text + ' {}, '.format(ver).strip()
        else:
            return return_text + ', '
    else:
        return ''


def get_sys_dimensions():
    # get some very basic system statistics
    sys = {}
    sys['cpu'] = psutil.cpu_count(logical=True)
    sys['ram'] = psutil.virtual_memory().total

    stdout, stderr, retc = execute_command_or_unknown('lsblk --nodeps --output SIZE --noheadings --include 8,252')
    sys['disks'] = stdout.count('\n') + 1
    sys['disk-sizes'] = re.sub('\s+', ' ', stdout)
    return sys


def get_apps():
    # try to find some non-yum-installed software - here called "apps";
    # mainly found in /home, /opt or /var/www/html;
    # and: this is just an incomplete and naive guess
    apps = ''

    apps += 'H-Net SecureService (eFaktura), ' if os.path.isdir('/home/hnet/HnetSecureService') else ''

    apps += 'Atlassian Bitbucket, ' if os.path.isdir('/opt/atlassian/bitbucket') else ''
    apps += 'Atlassian Confluence, ' if os.path.isdir('/opt/atlassian/confluence') else ''
    apps += 'Atlassian Jira, ' if os.path.isdir('/opt/atlassian/jira') else ''
    apps += 'Atomicorp, ' if os.path.isdir('/opt/atomicorp') else ''
    apps += 'Bacchus, ' if os.path.isdir('/opt/bacchus') else ''
    apps += 'BizBus, ' if os.path.isdir('/opt/bizbus') else ''
    apps += 'Brother Printer SW, ' if os.path.isdir('/opt/brother') else ''
    apps += 'Collabora Office 5.3, ' if os.path.isdir('/opt/collaboraoffice5.3') else ''
    apps += 'Collabora Office 6.0, ' if os.path.isdir('/opt/collaboraoffice6.0') else ''
    apps += 'DCM4CHEE, ' if os.path.isdir('/opt/dcm4chee') else ''
    apps += 'F5 VPN SW, ' if os.path.isdir('/opt/f5/vpn') else ''
    apps += 'GitLab, ' if os.path.isdir('/opt/gitlab') else ''
    apps += 'Google Chrome, ' if os.path.isdir('/opt/google/chrome') else ''
    apps += 'JBoss, ' if os.path.isdir('/opt/jboss') else ''
    apps += 'JumpCloud, ' if os.path.isdir('/opt/jc') else ''
    apps += 'KeeWeb, ' if os.path.isdir('/opt/KeeWeb') else ''
    apps += 'Keycloak, ' if os.path.isdir('/opt/keycloak') else ''
    apps += 'MariaDB ColumnStore, ' if os.path.isdir('/opt/columnstore') else ''
    apps += 'Medidata (eFaktura), ' if os.path.isdir('/opt/MPCommunicator') else ''
    apps += 'Metabase, ' if os.path.isdir('/opt/metabase') else ''
    apps += 'NodeBB, ' if os.path.isdir('/opt/nodebb') else ''
    apps += 'PHP 7.1 (RH), ' if os.path.isdir('/opt/rh/rh-php71') else ''
    apps += 'PHP 7.2 (RH), ' if os.path.isdir('/opt/rh/rh-php72') else ''
    apps += 'PHP 7.3 (RH), ' if os.path.isdir('/opt/rh/rh-php73') else ''
    apps += 'PHP 7.4 (RH), ' if os.path.isdir('/opt/rh/rh-php74') else ''
    apps += 'PostgreSQL 9.0 (RH), ' if os.path.isdir('/opt/rh/rh-postgresql90') else ''
    apps += 'PostgreSQL 9.1 (RH), ' if os.path.isdir('/opt/rh/rh-postgresql91') else ''
    apps += 'PostgreSQL 9.2 (RH), ' if os.path.isdir('/opt/rh/rh-postgresql92') else ''
    apps += 'PostgreSQL 9.3 (RH), ' if os.path.isdir('/opt/rh/rh-postgresql93') else ''
    apps += 'PostgreSQL 9.4 (RH), ' if os.path.isdir('/opt/rh/rh-postgresql94') else ''
    apps += 'PostgreSQL 9.5 (RH), ' if os.path.isdir('/opt/rh/rh-postgresql95') else ''
    apps += 'PostgreSQL 9.6 (RH), ' if os.path.isdir('/opt/rh/rh-postgresql96') else ''
    apps += 'Rambox, ' if os.path.isdir('/opt/Rambox') else ''
    apps += 'Rocket.Chat, ' if os.path.isdir('/opt/Rocket.Chat') else ''
    apps += 'Tarifpool, ' if os.path.isdir('/opt/tarifpool') else ''
    apps += 'WildFly, ' if os.path.isdir('/opt/wildfly') else ''
    apps += 'Zimbra, ' if os.path.isdir('/opt/zimbra') else ''

    apps += 'Contao, ' if os.path.isdir('/var/www/html/contao') else ''
    apps += 'HTMLy, ' if os.path.isdir('/var/www/html/htmly') else ''
    apps += 'Matomo, ' if os.path.isdir('/var/www/html/matomo') else ''
    apps += 'MediaWiki, ' if os.path.isdir('/var/www/html/mediawiki') else ''
    apps += 'Nextcloud, ' if os.path.isdir('/var/www/html/nextcloud') else ''
    apps += 'Piwik, ' if os.path.isdir('/var/www/html/piwik') else ''
    apps += 'Roundcube, ' if os.path.isdir('/var/www/html/roundcubemail') else ''
    apps += 'Vtiger, ' if os.path.isdir('/var/www/html/vtigercrm') else ''
    apps += 'Yii, ' if os.path.isdir('/var/www/html/yii') else ''
    apps += 'Yii2, ' if os.path.isdir('/var/www/html/yii2') else ''
    apps += 'Yii2, ' if os.path.isdir('/var/www/html/yii2-basic') else ''
    apps += 'Yii2, ' if os.path.isdir('/var/www/html/yii2-advanced') else ''

    if apps:
        return apps[:-2]
    else:
        return ''


def get_repo_sw():
    # yum installed Software, alphabetically sorted by output
    sw = ''

    sw += find_command('Apache httpd', 'command -v httpd', version_cmd='httpd -v', version_regex='Apache/(.*) ')
    sw += find_command('BIND', 'command -v named', version_cmd='named -v', version_regex='^BIND (.*?)-')
    sw += find_command('Borg', 'command -v borg', version_cmd='borg --version', version_regex=' (.*)')
    sw += find_command('Containerd', 'command -v containerd', version_cmd='containerd --version', version_regex=' (.*) ')
    sw += find_command('Docker', 'command -v docker', version_cmd='docker --version', version_regex=' version (.*?),')
    sw += 'Elasticsearch, ' if os.path.isfile('/usr/share/elasticsearch/bin/elasticsearch') else ''
    sw += find_command('Erlang', 'command -v erl', version_cmd='erl -noshell -eval \'io:fwrite("~s\n", [erlang:system_info(otp_release)]).\' -s erlang halt')
    sw += find_command('Fail2ban-Server', 'command -v fail2ban-server', version_cmd='fail2ban-server --version', version_regex=' v(.*)')
    sw += find_command('FreeIPA', 'command -v ipa', version_cmd='ipa --version', version_regex=' (.*?),')
    sw += 'Graylog-Server, ' if os.path.isfile('/usr/share/graylog-server/bin/graylog-server') else ''
    sw += find_command('LibreOffice', 'command -v libreoffice', version_cmd='libreoffice --version', version_regex=' (.*?) ')
    sw += find_command('LibreOffice Online (LOOL)', 'command -v loolwsd')
    sw += find_command('MariaDB', 'command -v mysqld', version_cmd='mysqld --version', version_regex='Ver (.*?)-')
    sw += find_command('Mongo', 'command -v mongod', version_cmd='mongod --version', version_regex='db version v(.*?)\n')
    sw += find_command('Node', 'command -v node', version_cmd='node --version', version_regex='v(.*)')
    sw += find_command('Perl', 'command -v perl', version_cmd='perl --version', version_regex=' \(v(.*?)\) ')
    sw += find_command('PHP', 'command -v php', version_cmd='php --version', version_regex='PHP (.*?) \(.*')
    sw += find_command('PostgreSQL', 'command -v psql', version_cmd='psql --version', version_regex='\(PostgreSQL\) (.*)')
    # Python 2 does not work, because it sends its version information to STDERR...
    #sw += find_command('Python2', 'command -v python2', version_cmd='python --version', version_regex=' (.*)')
    sw += find_command('Python3', 'command -v python3', version_cmd='python3 --version', version_regex=' (.*)')
    sw += find_command('RabbitMQ-Server', 'command -v rabbitmq-server', version_cmd='rabbitmqctl --version')
    sw += find_command('Redis-Server', 'command -v redis-server', version_cmd='redis-server --version', version_regex=' v=(.*?) ')
    sw += find_command('Sublime Text', 'command -v subl', version_cmd='subl --version', version_regex='.* (.*)$')
    sw += find_command('TeamViewer', 'command -v teamviewer', version_cmd='teamviewer --version', version_regex='   (.*) ')
    sw += find_command('Wireshark', 'command -v tshark', version_cmd='tshark -v', version_regex='TShark (.*?) ')

    if sw:
        return sw[:-2]
    else:
        return ''


def main():
    # parse the command line, exit with UNKNOWN if it fails
    try:
        parsed = define_args()
    except SystemExit as e:
        exit(STATE_UNKNOWN)


    msg = ''
    state = STATE_OK

    # 12 CPUs, 252GB RAM, 6 Disks (489.1G 489.1G 10.9T 10.9T 10.9T 10.9T) - Apps: Atlassian Jira, Keycloak - Software: Apache httpd 2.4.6, BIND, FreeIPA - OS: CentOS Linux release 7.4.1708 (Core)  3.10.0-693.21.1.el7.x86_64

    sys_dimensions = get_sys_dimensions()
    apps = get_apps()
    repos_sw = get_repo_sw()


    if sys_dimensions['cpu'] == 1:
        msg += '{} CPU, '.format(sys_dimensions['cpu'])
    else:
        msg += '{} CPUs, '.format(sys_dimensions['cpu'])
    msg += bytes2human(sys_dimensions['ram']) + ' RAM, '
    if sys_dimensions['disks'] == 1:
        msg += '{} Disk ({}), '.format(sys_dimensions['disks'], sys_dimensions['disk-sizes'])
    else:
        msg += '{} Disks ({}), '.format(sys_dimensions['disks'], sys_dimensions['disk-sizes'])
    msg = msg[:-2]


    if repos_sw:
        msg += ' - SW: ' + repos_sw 

    if apps:
        msg += ' - Apps: ' + apps 


    perfdata  = unpack_perfdata('cpu', sys_dimensions['cpu'], None, None, None, 0, None)
    perfdata += unpack_perfdata('ram', sys_dimensions['ram'], 'B', None, None, 0, None)
    perfdata += unpack_perfdata('disks', sys_dimensions['disks'], None, None, None, 0, None)


    print(msg + '|' + perfdata.strip())
    return(state)


if __name__ == '__main__':
    main()

